---
name: Comment with Recent PRs

'on':
  pull_request:
    types: [opened]

jobs:
  comment-recent-prs:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Get last 5 PRs
        id: get-prs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              sort: 'created',
              direction: 'desc',
              per_page: 6  // Get 6 to exclude current PR
            });

            // Filter out the current PR and take the last 5
            const recentPRs = prs
              .filter(pr => pr.number !== context.payload.pull_request.number)
              .slice(0, 5);

            // Format the PR links
            let comment = '## ðŸ“‹ Recent Pull Requests\n\n';
            comment += 'Here are the last 5 pull requests in this ';
            comment += 'repository:\n\n';

            if (recentPRs.length === 0) {
              comment += '_No previous pull requests found._\n';
            } else {
              recentPRs.forEach((pr, index) => {
                const status = pr.state === 'open' ? 'ðŸŸ¢' :
                  pr.merged_at ? 'ðŸŸ£' : 'ðŸ”´';
                const prUrl = pr.html_url;
                const prTitle = pr.title;
                const line = `${index + 1}. ${status} `;
                comment += `${line}[#${pr.number}](${prUrl}) - ${prTitle}\n`;
              });
            }

            return comment;

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const comment = ${{ steps.get-prs.outputs.result }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
